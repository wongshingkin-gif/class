<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>èª²å ‚ç´€éŒ„ç³»çµ±</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="èª²å ‚ç´€éŒ„">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2995/2995620.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#4a90e2">

  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* CSS æ¨£å¼è¡¨å®Œå…¨ä¿ç•™æ‚¨çš„åŸå§‹è¨­è¨ˆ */
    :root { --primary: #4a90e2; --bg: #f4f7f6; --card-bg: #fff; --green: #2ecc71; --red: #e74c3c; --text: #333; --gray: #95a5a6; }
    body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; padding-bottom: 40px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(244, 247, 246, 0.98); position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    select { padding: 10px; font-size: 16px; border-radius: 10px; border: 1px solid #ddd; background: white; width: 50%; outline: none; }
    .stats-btn { background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 5px rgba(74, 144, 226, 0.3); }
    .container { padding: 0 15px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 10px; }
    .card { background: var(--card-bg); border-radius: 12px; padding: 12px 5px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); cursor: pointer; position: relative; border-bottom: 3px solid #eee; transition: transform 0.1s; }
    .card:active { transform: scale(0.97); background: #fafafa; }
    .card.positive { border-bottom-color: var(--green); }
    .card.negative { border-bottom-color: var(--red); }
    .stu-id { font-size: 11px; color: #999; }
    .stu-name { font-size: 16px; font-weight: bold; margin: 4px 0; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stu-score { font-size: 18px; font-weight: 800; color: var(--primary); background: #eff6ff; display: inline-block; padding: 2px 10px; border-radius: 12px; min-width: 30px; }
    .stu-score.neg { color: var(--red); background: #fef2f2; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; justify-content: center; align-items: flex-end; }
    .modal.active { display: flex; }
    .sheet { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; display: flex; flex-direction: column; animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    .sheet-header { text-align: center; margin-bottom: 15px; flex-shrink: 0; }
    .sheet-title { font-size: 1.3em; font-weight: bold; color: #333; }
    .sheet-subtitle { color: #888; font-size: 0.9em; margin-top: 5px; }
    .modal-tabs { display: flex; margin-bottom: 15px; background: #f0f2f5; border-radius: 10px; padding: 4px; flex-shrink: 0; }
    .tab-item { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #7f8c8d; font-size: 14px; transition: 0.2s; }
    .tab-item.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .tab-content { flex: 1; overflow-y: auto; display: none; padding-bottom: 10px;}
    .tab-content.active { display: block; }
    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .action-btn { padding: 12px 5px; border: none; border-radius: 12px; font-size: 13px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; background: #f8f9fa; font-weight: 500; color: #555; }
    .action-btn:active { transform: scale(0.95); background: #eee; }
    .action-btn.add { background: #eefbf4; color: #219653; border: 1px solid #d4f7e3; }
    .action-btn.minus { background: #fef2f2; color: #eb5757; border: 1px solid #fdebeb; }
    .action-icon { font-size: 24px; }
    .history-list { list-style: none; padding: 0; margin: 0; }
    .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .h-left { display: flex; flex-direction: column; width: 85px; }
    .h-time { font-size: 11px; color: #aaa; }
    .h-info { flex: 1; text-align: left; font-size: 14px; color: #333; padding-left: 10px;}
    .h-right { display: flex; align-items: center; gap: 15px; }
    .h-score { font-weight: bold; width: 25px; text-align: right; }
    .h-score.plus { color: var(--green); }
    .h-score.minus { color: var(--red); }
    .del-btn { background: none; border: none; font-size: 16px; cursor: pointer; opacity: 0.4; padding: 5px; }
    .del-btn:hover { opacity: 1; transform: scale(1.1); }
    .close-btn { width: 100%; padding: 14px; margin-top: 10px; border: none; background: #f0f2f5; color: #555; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; flex-shrink: 0; }
    #stats-view { display: none; padding: 0 15px; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: var(--primary); color: white; font-weight: normal; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: #f4f7f6; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #555; }
    .spinner { font-size: 40px; animation: spin 1s infinite linear; margin-bottom: 15px;}
    @keyframes spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner">â³</div>
  <p id="loading-text">æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
</div>

<div id="main-view">
  <div class="header">
    <select id="classSelect" onchange="renderStudents()"><option>...</option></select>
    <button class="stats-btn" onclick="toggleStats(true)">ğŸ† æ’è¡Œæ¦œ</button>
  </div>
  <div class="container"><div class="grid" id="studentGrid"></div></div>
</div>

<div id="stats-view">
  <div class="header">
    <h2 style="margin:0; font-size:18px;">ğŸ† ç©åˆ†æ¦œ</h2>
    <button class="stats-btn" onclick="toggleStats(false)" style="background: var(--gray);">â†© è¿”å›</button>
  </div>
  <table>
    <thead><tr><th>#</th><th>å§“å</th><th style="text-align:right">ç¸½åˆ†</th></tr></thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<div class="modal" id="actionModal" onclick="if(event.target === this) closeModal()">
  <div class="sheet">
    <div class="sheet-header">
      <div class="sheet-title" id="modalStuName"></div>
      <div class="sheet-subtitle" id="modalStuId"></div>
    </div>
    
    <div class="modal-tabs">
      <div class="tab-item active" onclick="switchModalTab('grade')">âœ¨ è©•åˆ†</div>
      <div class="tab-item" onclick="switchModalTab('history')">ğŸ“œ ç´€éŒ„</div>
    </div>
    
    <div id="tab-grade" class="tab-content active">
      <div class="action-grid" id="actionButtons"></div>
    </div>
    
    <div id="tab-history" class="tab-content">
      <ul class="history-list" id="historyList"></ul>
    </div>
    
    <button class="close-btn" onclick="closeModal()">é—œé–‰</button>
  </div>
</div>

<script>
  // ==========================================
  // âš ï¸ è«‹åœ¨æ­¤å¡«å¯«æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€
  // ==========================================
  const GAS_URL = "YOUR_GAS_URL_HERE"; 

  let rawData = {}; 
  let selectedStudent = null;

  // è¨»å†Š Service Worker (PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("Service Worker è¨»å†ŠæˆåŠŸ"))
      .catch(err => console.log("Service Worker è¨»å†Šå¤±æ•—", err));
  }

  // åˆå§‹åŒ–ï¼šé€é Fetch API è·Ÿå¾Œç«¯è¦è³‡æ–™
  window.onload = async function() { 
    try {
      // åŠ ä¸Š ?action=getInitData è®“å¾Œç«¯çŸ¥é“æˆ‘å€‘è¦å¹¹å˜›
      const response = await fetch(`${GAS_URL}?action=getInitData`);
      const data = await response.json();
      initApp(data);
    } catch (error) {
      document.getElementById('loading-text').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€è¨­å®šã€‚";
      console.error("è¼‰å…¥å¤±æ•—:", error);
    }
  };

  function initApp(data) {
    rawData = data;
    const select = document.getElementById('classSelect');
    select.innerHTML = '';
    
    if (data.classes.length === 0) select.add(new Option("ç„¡è³‡æ–™", ""));
    else data.classes.forEach(c => select.add(new Option(c, c)));
    
    const actionContainer = document.getElementById('actionButtons');
    actionContainer.innerHTML = '';
    data.actions.forEach(act => {
      let btn = document.createElement('button');
      let typeClass = act.score >= 0 ? 'add' : 'minus';
      btn.className = `action-btn ${typeClass}`;
      let icon = act.icon || (act.score >=0 ? 'ğŸ‘' : 'âš ï¸');
      btn.innerHTML = `<span class="action-icon">${icon}</span><span>${act.name}</span><span style="font-size:11px; opacity:0.8">${act.score>0?'+':''}${act.score}</span>`;
      btn.onclick = () => submitScore(act);
      actionContainer.appendChild(btn);
    });

    if(data.classes.length > 0) { select.value = data.classes[0]; renderStudents(); }
    document.getElementById('loading').style.display = 'none';
  }

  // æ¸²æŸ“å­¸ç”Ÿåå–® (èˆ‡åŸæœ¬ç›¸åŒ)
  function renderStudents() {
    const cls = document.getElementById('classSelect').value;
    const grid = document.getElementById('studentGrid');
    grid.innerHTML = '';
    const students = rawData.students.filter(s => s.class === cls);
    if (students.length === 0) { grid.innerHTML = '<div style="color:#999;grid-column:1/-1;text-align:center;margin-top:20px">æ­¤ç­ç´šç„¡å­¸ç”Ÿ</div>'; return; }

    students.forEach(s => {
      let card = document.createElement('div');
      let scoreClass = s.totalScore < 0 ? 'negative' : 'positive';
      card.className = `card ${scoreClass}`;
      card.innerHTML = `<div class="stu-id">${s.id}</div><div class="stu-name">${s.name}</div><div class="stu-score ${s.totalScore<0?'neg':''}" id="score-${s.id}">${s.totalScore}</div>`;
      card.onclick = () => openModal(s);
      grid.appendChild(card);
    });
  }

  // é–‹å•Ÿ/é—œé–‰/åˆ‡æ› Modal (èˆ‡åŸæœ¬ç›¸åŒ)
  function openModal(student) {
    selectedStudent = student;
    document.getElementById('modalStuName').innerText = student.name;
    updateModalHeader();
    switchModalTab('grade');
    renderHistory(student);
    document.getElementById('actionModal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('actionModal').classList.remove('active');
    setTimeout(() => { selectedStudent = null; }, 200);
  }
  
  function updateModalHeader() {
    if(!selectedStudent) return;
    document.getElementById('modalStuId').innerText = `å­¸è™Ÿ: ${selectedStudent.id} | åˆ†æ•¸: ${selectedStudent.totalScore}`;
  }

  function switchModalTab(tabName) {
    document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    if(tabName === 'grade') document.querySelector('.tab-item:nth-child(1)').classList.add('active');
    else document.querySelector('.tab-item:nth-child(2)').classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
  }

  // --- è©•åˆ†åŠŸèƒ½ ---
  function submitScore(action) {
    if (!selectedStudent) return;
    
    if (!confirm(`ç¢ºå®šçµ¦äºˆã€Œ${selectedStudent.name}ã€\né …ç›®ï¼š${action.name} (${action.score > 0 ? '+' : ''}${action.score}) å—ï¼Ÿ`)) {
      return;
    }
    
    let points = Number(action.score);
    selectedStudent.totalScore += points;
    
    let now = new Date();
    let timeDisplay = (now.getMonth()+1) + "/" + now.getDate() + " " + now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
    let y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
    let h = String(now.getHours()).padStart(2,'0'), min = String(now.getMinutes()).padStart(2,'0'), sec = String(now.getSeconds()).padStart(2,'0');
    let timeId = `${y}-${m}-${d} ${h}:${min}:${sec}`;

    if(!selectedStudent.history) selectedStudent.history = [];
    selectedStudent.history.push({ tid: timeId, t: timeDisplay, i: action.name, s: points });

    updateUI(selectedStudent);
    switchModalTab('history');

    const record = {
      class: selectedStudent.class,
      studentId: String(selectedStudent.id),
      studentName: selectedStudent.name,
      actionName: action.name,
      score: action.score
    };

    // æ›¿æ›ç‚º Fetch API (å‚³é€ POST çµ¦å¾Œç«¯)
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify({ action: "submitScore", data: record })
    }).catch(e => console.error("è©•åˆ†ä¸Šå‚³å¤±æ•—:", e));
  }

  // --- åˆªé™¤åŠŸèƒ½ ---
  function deleteHistory(index) {
    if(!selectedStudent) return;
    let item = selectedStudent.history[index];
    
    if(!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ\n\né …ç›®ï¼š${item.i}\nåˆ†æ•¸ï¼š${item.s}`)) return;

    selectedStudent.totalScore -= Number(item.s);
    selectedStudent.history.splice(index, 1);
    updateUI(selectedStudent);

    const deleteData = {
      studentId: String(selectedStudent.id),
      timeId: item.tid,
      score: item.s
    };

    // æ›¿æ›ç‚º Fetch API (å‚³é€ POST çµ¦å¾Œç«¯)
    fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify({ action: "deleteScore", data: deleteData })
    }).catch(e => console.error("åˆªé™¤è«‹æ±‚å¤±æ•—:", e));
  }

  // æ¸²æŸ“æ­·å²ç´€éŒ„ (èˆ‡åŸæœ¬ç›¸åŒ)
  function renderHistory(student) {
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    const history = student.history ? [...student.history] : []; 

    if (history.length === 0) { list.innerHTML = '<li style="text-align:center;color:#ccc;margin-top:20px">å°šç„¡ç´€éŒ„</li>'; return; }

    for (let i = history.length - 1; i >= 0; i--) {
      let h = history[i];
      let li = document.createElement('li');
      li.className = 'history-item';
      let scoreTxt = h.s > 0 ? `+${h.s}` : h.s;
      let scoreCls = h.s >= 0 ? 'plus' : 'minus';
      
      li.innerHTML = `
        <div class="h-left"><span class="h-time">${h.t}</span></div>
        <div class="h-info">${h.i}</div>
        <div class="h-right">
          <span class="h-score ${scoreCls}">${scoreTxt}</span>
          <button class="del-btn" onclick="deleteHistory(${i})">ğŸ—‘ï¸</button>
        </div>
      `;
      list.appendChild(li);
    }
  }

  function updateUI(stu) {
    const scoreEl = document.getElementById(`score-${stu.id}`);
    if(scoreEl) {
      scoreEl.innerText = stu.totalScore;
      if(stu.totalScore < 0) scoreEl.classList.add('neg'); else scoreEl.classList.remove('neg');
    }
    updateModalHeader();
    renderHistory(stu);
  }

  function toggleStats(show) {
    document.getElementById('main-view').style.display = show ? 'none' : 'block';
    document.getElementById('stats-view').style.display = show ? 'block' : 'none';
    window.scrollTo(0, 0);
    if(show) {
      const cls = document.getElementById('classSelect').value;
      const tbody = document.getElementById('statsBody');
      tbody.innerHTML = '';
      let list = rawData.students.filter(s => s.class === cls).sort((a,b) => b.totalScore - a.totalScore);
      list.forEach((s, i) => {
        let rank = i+1; if(rank===1) rank='ğŸ¥‡'; else if(rank===2) rank='ğŸ¥ˆ'; else if(rank===3) rank='ğŸ¥‰';
        tbody.innerHTML += `<tr><td>${rank}</td><td>${s.name}</td><td style="text-align:right;font-weight:bold;color:var(--primary)">${s.totalScore}</td></tr>`;
      });
    }
  }
</script>
</body>
</html>
